using System;
using System.Collections.Generic;
using NUnit.Framework;
using UnityEngine;

public class ParkTest
{
    private Park _park;
    private bool _notifiedForAwardReceived = false;

    [SetUp]
    public void setupTest()
    {
        GameObject tempGameObject = new GameObject();
        tempGameObject.AddComponent<Park>();
        tempGameObject.AddComponent<MockTimer>();
        _park = tempGameObject.GetComponent<Park>();
        _park.Timer = tempGameObject.GetComponent<MockTimer>();
    }

    [Test]
    public void shouldHaveGuestCountInitializedTo0()
    {
        Assert.AreEqual(0, _park.GuestsCount);
    }

    [Test]
    public void shouldSpawnGuestsWithDefaultSpawnRateOf1()
    {
        Assert.AreEqual(0, _park.GuestsCount);
        _park.SpawnGuests();
        Assert.AreEqual(1, _park.GuestsCount);
    }

    [Test]
    public void shouldHaveBankrollInitializedTo0()
    {
        Assert.AreEqual(0f, _park.Bankroll);
    }

    [Test]
    public void shouldBeAbleToSetAdmissionFee()
    {
        _park.BaseAdmissionFee = 40f;
        Assert.AreEqual(40f, _park.AdmissionFee);
    }

    [Test]
    public void shouldPerceiveAdmissionFeeFromNewGuests()
    {
        Assert.AreEqual(0, _park.GuestsCount);
        Assert.AreEqual(0, _park.Bankroll);

        _park.BaseAdmissionFee = 40f;
        _park.SpawnGuests();

        Assert.AreEqual(1, _park.GuestsCount);
        Assert.AreEqual(40f, _park.Bankroll);
    }

    [Test]
    public void shouldSpawnAdditionalGuestsIfRequired()
    {
        Assert.AreEqual(0, _park.GuestsCount);
        Assert.AreEqual(0, _park.Bankroll);

        _park.BaseAdmissionFee = 40f;
        _park.SpawnGuests(5);

        Assert.AreEqual(5, _park.GuestsCount);
        Assert.AreEqual(5f * 40f, _park.Bankroll);
    }

    [Test]
    public void shouldAddToBankrollCorrectly()
    {
        Assert.AreEqual(0f, _park.Bankroll);
        _park.AddToBankroll(100f);
        Assert.AreEqual(100f, _park.Bankroll);
        _park.AddToBankroll(150f);
        Assert.AreEqual(250f, _park.Bankroll);
    }

    [Test]
    public void shouldRemoveFromBankrollCorrectly()
    {
        _park.AddToBankroll(100f);
        Assert.AreEqual(100f, _park.Bankroll);

        Assert.IsTrue(_park.SpendMoney(60f));
        Assert.AreEqual(40f, _park.Bankroll);

        // Not enough money left, transaction fails
        Assert.IsFalse(_park.SpendMoney(60f));
        Assert.AreEqual(40f, _park.Bankroll);
    }

    [Test]
    public void shouldComputeAdmissionFeeCorrectly()
    {
        // Admission fee computed as follow:
        // (Base admission fee) + (for each ride: contribution to admission fee) - (for each ad campaign: rebate)
        _park.BaseAdmissionFee = 10f;
        Assert.AreEqual(10f, _park.AdmissionFee);

        Ride ride1 = CreateMockRide(5f);
        Ride ride2 = CreateMockRide(10f);
        _park.AddNewRide(ride1);
        _park.AddNewRide(ride2);
        Assert.AreEqual(25f, _park.AdmissionFee);

        AdvertisingCampaign a1 = CreateAdCampaign(5f, 0f);
        AdvertisingCampaign a2 = CreateAdCampaign(2f, 0f);
        _park.StartAdCampaign(a1);
        _park.StartAdCampaign(a2);
        Assert.AreEqual(18f, _park.AdmissionFee);
    }

    [Test]
    public void admissionFeeShouldntBeLessThanZero()
    {
        // The admission fee shouldn't be less than 0 (we shouldn't pay guests to enter the park lol)
        AdvertisingCampaign a3 = CreateAdCampaign(100f, 0f);
        _park.StartAdCampaign(a3);
        Assert.AreEqual(0f, _park.AdmissionFee);
    }

    [Test]
    public void shouldComputeSpawnRateCorrectly()
    {
        // Spawn rate computed as follow
        // 1 * (for each ad campaign: spawn rate)
        // Number of guests generated by one call to spawn is:
        // floor(nbr_guests_to_spawn * spawn_rate)
        Assert.AreEqual(0, _park.GuestsCount);

        _park.SpawnGuests();
        Assert.AreEqual(1f, _park.SpawnRate);
        Assert.AreEqual(1, _park.GuestsCount);

        // Spawn rate will be 1.5 * 1.25 = 1.875
        AdvertisingCampaign adCampaign1 = CreateAdCampaign(0f, 1.5f);
        AdvertisingCampaign adCampaign2 = CreateAdCampaign(0f, 1.25f);
        _park.StartAdCampaign(adCampaign1);
        _park.StartAdCampaign(adCampaign2);
        Assert.AreEqual(1.875f, _park.SpawnRate);

        _park.SpawnGuests(5); // 5 * 1.875 = 9.375 => 9 guests spawned
        Assert.AreEqual(10, _park.GuestsCount);
    }

    [Test]
    public void shouldStartAdCampaignCorrectly()
    {
        AdvertisingCampaign campaignPrefab = CreateAdCampaign();

        IEnumerator<AdvertisingCampaign> campaigns = _park.AdvertisingCampaigns.GetEnumerator();
        Assert.IsFalse(campaigns.MoveNext());

        _park.StartAdCampaign(campaignPrefab);
        IEnumerator<AdvertisingCampaign> campaignsAfterAdd = _park.AdvertisingCampaigns.GetEnumerator();
        Assert.IsTrue(campaignsAfterAdd.MoveNext());
        Assert.IsFalse(campaignsAfterAdd.MoveNext()); // Contains one ad campaign
    }

    [Test]
    public void shouldTerminateAdCampaignCorrectly()
    {
        AdvertisingCampaign campaignPrefab = CreateAdCampaign();

        _park.StartAdCampaign(campaignPrefab);
        IEnumerator<AdvertisingCampaign> campaignsBeforeRemove = _park.AdvertisingCampaigns.GetEnumerator();
        campaignsBeforeRemove.MoveNext();
        _park.StopAdCampaign(campaignsBeforeRemove.Current);
        IEnumerator<AdvertisingCampaign> campaignsAfterRemove = _park.AdvertisingCampaigns.GetEnumerator();
        Assert.IsFalse(campaignsAfterRemove.MoveNext());
    }

    [Test]
    public void shouldHireEmployeeCorrectly()
    {
        Employee employeePrefab = CreateEmployeePrefab();

        IEnumerator<Employee> employees = _park.Employees.GetEnumerator();
        Assert.IsFalse(employees.MoveNext());

        _park.HireEmployee(employeePrefab);
        IEnumerator<Employee> employeesAfterAdd = _park.Employees.GetEnumerator();
        Assert.IsTrue(employeesAfterAdd.MoveNext());
        Assert.IsFalse(employeesAfterAdd.MoveNext()); // Contains one employee
    }

    [Test]
    public void shouldFurloughEmployeeCorrectly()
    {
        Employee employeePrefab = CreateEmployeePrefab();

        _park.HireEmployee(employeePrefab);
        IEnumerator<Employee> employeesBeforeRemove = _park.Employees.GetEnumerator();
        employeesBeforeRemove.MoveNext();
        _park.FurloughEmployee(employeesBeforeRemove.Current);
        IEnumerator<Employee> employeesAfterRemove = _park.Employees.GetEnumerator();
        Assert.IsFalse(employeesAfterRemove.MoveNext());
    }

    [Test]
    public void shouldAddRideCorrectly()
    {
        Ride ridePrefab = CreateMockRide();

        IEnumerator<Ride> rides = _park.Rides.GetEnumerator();
        Assert.IsFalse(rides.MoveNext());

        _park.AddNewRide(ridePrefab);
        IEnumerator<Ride> ridesAfterAdd = _park.Rides.GetEnumerator();
        Assert.IsTrue(ridesAfterAdd.MoveNext());
        Assert.IsFalse(ridesAfterAdd.MoveNext()); // Contains one ride
    }

    [Test]
    public void shouldAddShopCorrectly()
    {
        Shop shopPrefab = CreateMockShop();

        IEnumerator<Shop> shopsBeforeAdd = _park.Shops.GetEnumerator();
        Assert.IsFalse(shopsBeforeAdd.MoveNext());

        _park.AddNewShop(shopPrefab);
        IEnumerator<Shop> shopsAfterAdd = _park.Shops.GetEnumerator();
        Assert.IsTrue(shopsAfterAdd.MoveNext());
        Assert.IsFalse(shopsAfterAdd.MoveNext()); // Contains one shop
    }

    [Test]
    public void shouldCloseRideCorrectly()
    {
        Ride ridePrefab = CreateMockRide();

        _park.AddNewRide(ridePrefab);
        IEnumerator<Ride> ridesBeforeRemove = _park.Rides.GetEnumerator();
        ridesBeforeRemove.MoveNext();
        _park.CloseRide(ridesBeforeRemove.Current);
        IEnumerator<Ride> ridesAfterRemove = _park.Rides.GetEnumerator();
        Assert.IsFalse(ridesAfterRemove.MoveNext());
    }

    [Test]
    public void shouldCloseShopCorrectly()
    {
        Shop shopPrefab = CreateMockShop();

        _park.AddNewShop(shopPrefab);
        IEnumerator<Shop> shopsBeforeRemove = _park.Shops.GetEnumerator();
        shopsBeforeRemove.MoveNext();
        _park.CloseShop(shopsBeforeRemove.Current);
        IEnumerator<Shop> shopsAfterRemove = _park.Shops.GetEnumerator();
        Assert.IsFalse(shopsAfterRemove.MoveNext());
    }

    [Test]
    public void shouldAddAwardCorrectly()
    {
        Award award = MakeAward();

        IEnumerator<Award> awardsBeforeAdd = _park.Awards.GetEnumerator();
        Assert.IsFalse(awardsBeforeAdd.MoveNext());

        _park.AddAward(award);
        IEnumerator<Award> awardsAfterAdd = _park.Awards.GetEnumerator();
        Assert.IsTrue(awardsAfterAdd.MoveNext());
        Assert.AreEqual(award, awardsAfterAdd.Current);
        Assert.IsFalse(awardsAfterAdd.MoveNext());
    }

    [Test]
    public void shouldNotifyOnNewAwardReceived()
    {
        Assert.IsFalse(_notifiedForAwardReceived);
        _park.OnNewAwardReceived += AwardReceived;
        _park.AddAward(MakeAward());
        Assert.IsTrue(_notifiedForAwardReceived);
    }

    private void AwardReceived(object sender, EventArgs e)
    {
        _notifiedForAwardReceived = true;
    }

    private static Award MakeAward()
    {
        GameObject t = new GameObject();
        t.AddComponent<Award>();
        return t.GetComponent<Award>();
    }

    private static AdvertisingCampaign CreateAdCampaign(float rebateToAdmissionFee = 0f, float spawnRateIncrease = 1f)
    {
        GameObject temp = new GameObject();
        temp.AddComponent<AdvertisingCampaign>();
        temp.GetComponent<AdvertisingCampaign>().SpawnRateIncrease = spawnRateIncrease;
        temp.GetComponent<AdvertisingCampaign>().AdmissionFeeRebate = rebateToAdmissionFee;
        temp.GetComponent<AdvertisingCampaign>().MonthlyCost = 0f;
        return temp.GetComponent<AdvertisingCampaign>();
    }

    private static Ride CreateMockRide(float contributionToAdmFee = 0f)
    {
        GameObject temp = new GameObject();
        temp.AddComponent<Ride>();
        temp.GetComponent<Ride>().ContributionToAdmissionFee = contributionToAdmFee;
        return temp.GetComponent<Ride>();
    }

    private static Employee CreateEmployeePrefab()
    {
        GameObject t = new GameObject();
        t.AddComponent<SocialMediaManager>();
        return t.GetComponent<SocialMediaManager>();
    }

    private static Shop CreateMockShop()
    {
        GameObject t = new GameObject();
        t.AddComponent<Shop>();
        return t.GetComponent<Shop>();
    }
}
